## Pre-processing with Python

```
THIS MODULE IS UNDER DEVELOPMENT
```

To prepare the TIMES-NZ model files, we will be implementing pre-processing using the following command:

```
python prepare_times_nz.py
```

This script will handle the necessary steps to preprocess the data and ensure it is ready for further analysis and modeling.

Currently, a one-off script (`scripts/prepare_times_nz.py`) was used to produce the csv layout mirroring the existing structure (using the XL2TIMES `raw_tables.txt` as source data).

Then, `scripts/prepare_times_nz.py` uses these files to generate the smaller excel files, which Veda can use to produce TIMES runs. 

While this version of the model uses autogenerated excel files, all original excel input Veda files are still kept in the repo (`PREPARE-TIMES-NZ/data_raw/archive`). The logic and source data in these sheets needs to be readily available to enable further development work.

### TO DO

In the future, the input csvs, including input data, assumptions, and satellite model methods, will need to properly sourced and documented. The intent is that this work will be done for TIMES 3.0. The logic currently contained in excel sheets will ideally be reviewed and codified in scripts. Input data handling can also be automated as part of this workflow, increasing tracability. 

### Test Results

`tui-v2_1_3` was entirely rerun using the new autogenerated files in a new scenario called `tui-v2_1_3_iat`. This model run perfectly matches the original, so no information has been lost or modified in this process. 

### Veda and XL2TIMES differences

The raw files were generated based on the output of the times_excel_reader, which uses XL2TIMES to read the excel files.

There are a few minor differences between Veda and XL2TIMES interpretations of the excel files which needed to be resolved for this process to work properly. In these cases, we modified the original excel files so that Veda and XL2TIMES used matching interpretations. 

 - If a table tag is slightly misaligned (eg one column to the left of the table, with empty rows below it) then Veda will read this tag, but XL2TIMES will not. We shifted any misaligned tags to ensure consistency between methods.
 - If multiple tags within a worksheet have different uc_sets, then Veda will read the different tags with different uc_sets as intended. XL2TIMES instead currently applies all uc_sets found on a worksheet to all tags within that worksheet. To resolve this, we split some worksheets (such as `Scen_Individualistic.xlsx/Solar`) into multiple sheets with only one tag set between the tables. 

## General Future State

```mermaid
flowchart LR
    CSV[("CSV/TOML Files")]
    EXCEL["Excel Processing"]
    MIGRATE_FORMULAS["Migrate formula logic (iterative)"]
    VEDA["VEDA Analysis"]
    OUTPUT["Data Output"]
    SHINY["Public Shiny Dashboard"]
    
    INTERNAL_QA["Internal QA Tools"]    

    subgraph XL2TIMES["XL2Times"]
        EXCEL["Excel Processing"]
        VEDA["VEDA Analysis"]
    end



    CSV --> EXCEL
    EXCEL --> MIGRATE_FORMULAS
    MIGRATE_FORMULAS --> CSV
    EXCEL --> VEDA
    VEDA --> OUTPUT
    OUTPUT --> SHINY
    OUTPUT --> INTERNAL_QA
    


```
